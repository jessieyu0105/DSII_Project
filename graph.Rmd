---
title: ""
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  warning = FALSE,
  echo = FALSE
)

library(tidyverse)
library(glmnet)
library(plotmo)
library(caret)
library(RANN)

library(splines)
library(mgcv)
library(readr)
library(pls)

library(pdp)
library(earth)

library(corrplot)

theme_set(theme_bw() + theme(legend.position = "bottom"))

```

```{r}
# import data
data = read_csv("./data/dataset.final.csv") %>% 
  select(-X1, -county_name, -state_abbr)
```

### Table 1: Descriptive Statistics for Continuous Variables (At the County Level)

```{r}
# For continuous variables

table_1 = data %>% 
  select(-community_health_center_ind, -hpsa_ind) %>% 
  skimr::skim_to_wide() %>% 
  as.data.frame() %>%
  select(2, 3, 5, 6:7, 9:11) %>% 
  rename(
    "NAs" = missing,
    "N" = n,
    "Mean" = mean,
    "Std. Dev." = sd,
    "1st Quartile" = p25,
    "Median" = p50,
    "3rd Quartile" = p75
  ) %>% 
  mutate(
    variable = str_replace(variable, "population_density", "Population Density"),
    variable = str_replace(variable, "population_size", "Population Size"),
    variable = str_replace(variable, "age_19_64", "Percent with Age 19-64"),
    variable = str_replace(variable, "age_19_under", "Percent with Age <19"),
    variable = str_replace(variable, "age_65_84", "Percent with Age 65-84"),
    variable = str_replace(variable, "age_85_and_over", "Percent with Age 85+"),
    variable = str_replace(variable, "ale", "Average Life Expectancy"),
    variable = str_replace(variable, "asian", "Percent Asian"),
    variable = str_replace(variable, "black", "Percent Black"),
    variable = str_replace(variable, "diabetes", "Percent with Diabetes"),
    variable = str_replace(variable, "disabled_medicare", "Percent Medicare Based on Disability"),
    variable = str_replace(variable, "elderly_medicare", "Percent Medicare Based on Elderly Status"),
    variable = str_replace(variable, "few_fruit_veg", "Percent with Few Fruits or Vegetables"),
    variable = str_replace(variable, "health_status", "Percent with Health Status"),
    variable = str_replace(variable, "high_blood_pres", "Percent with High Blood Pressure"),
    variable = str_replace(variable, "hispanic", "Percent Hispanic"),
    variable = str_replace(variable, "major_depression ", "Percent with Major Depression"),
    variable = str_replace(variable, "native_american", "Percent Native American"),
    variable = str_replace(variable, "no_hs_diploma", "Percent with No High School Diploma"),
    variable = str_replace(variable, "obesity", "Percent Obese"),
    variable = str_replace(variable, "poverty", "Percent Poverty"),
    variable = str_replace(variable, "prim_care_phys_rate", "Physician Rate"),
    variable = str_replace(variable, "recent_drug_use", "Percent with Recent Drug Use"),
    variable = str_replace(variable, "smoker", "Percent Smoking"),
    variable = str_replace(variable, "unemployed", "Percent Unemployed"),
    variable = str_replace(variable, "unhealthy_days", "Number of Monthly Unhealthy Day"),
    variable = str_replace(variable, "uninsured", "Percent Uninsured"),
    variable = str_replace(variable, "white", "Percent White")
    ) %>% 
  rename("Variable (Per County)" = variable) %>% 
  knitr::kable()
```

|Variable (Per County)                    |NAs  |N    |Mean     |Std. Dev. |1st Quartile |Median |3rd Quartile |
|:----------------------------------------|:----|:----|:--------|:---------|:------------|:------|:------------|
|Average Life Expectancy                  |0    |3139 |76.32    |2         |75           |76.5   |77.7         |
|Population Density                       |1    |3139 |250.07   |1703.27   |17           |44     |109.75       |
|Population Size                          |0    |3139 |94427.06 |306520.4  |11220        |25270  |64111        |
|Percent with Age <19                     |0    |3139 |24.81    |3.28      |22.7         |24.6   |26.4         |
|Percent with Age 19-64                   |0    |3139 |60.28    |3.35      |58.3         |60.3   |62.3         |
|Percent with Age 65-84                   |0    |3139 |12.79    |3.33      |10.7         |12.5   |14.7         |
|Percent with Age 85+                     |0    |3139 |2.12     |0.95      |1.5          |1.9    |2.6          |
|Percent White                            |0    |3139 |87.04    |16.14     |82.8         |94.1   |97.6         |
|Percent Black                            |0    |3139 |8.99     |14.55     |0.5          |2.1    |10.3         |
|Percent Native American                  |0    |3139 |1.95     |7.62      |0.2          |0.4    |0.9          |
|Percent Asian                            |0    |3139 |1.12     |2.76      |0.3          |0.5    |1            |
|Percent Hispanic                         |0    |3139 |7.02     |12.47     |1.1          |2.3    |6.3          |
|Death Rate                               |3    |3139 |905.64   |131.21    |814.25       |898.6  |989.8        |
|Percent with Health Status               |662  |3139 |17.32    |6.09      |12.9         |16.4   |20.9         |
|Number of Monthly Unhealthy Days         |0    |3139 |0.019    |0.36      |0.021        |0.025  |0.03         |
|Percent not Exercising                   |933  |3139 |26.51    |6.7       |21.9         |26     |30.8         |
|Percent with Few Fruits or Vegetables    |1235 |3139 |78.92    |5.16      |75.5         |79     |82.4         |
|Percent Obese                            |915  |3139 |24.15    |4.9       |21.1         |24.3   |27.2         |
|Percent with High Blood Pressure         |1617 |3139 |26.48    |5.44      |22.8         |26.2   |29.9         |
|Percent Smoking                          |872  |3139 |23.11    |5.73      |19.4         |23     |26.7         |
|Percent with Diabetes                    |420  |3139 |7.81     |2.76      |5.9          |7.5    |9.45         |
|Physician Rate                           |0    |3139 |57.6     |44.78     |30.55        |50.6   |74.7         |
|Dentist Rate                             |1    |3139 |32.19    |21.5      |18.7         |30     |43.3         |
|Percent Poverty                          |1    |3139 |13.35    |4.88      |9.8          |12.6   |16.2         |
|Percent Unemployed                       |543  |3139 |6.11     |1.34      |5.2          |6      |6.8          |
|Percent Uninsured                        |0    |3139 |0.14     |0.36      |0.11         |0.13   |0.17         |
|Percent Medicare Based on Disability     |0    |3139 |-0.017   |0.79      |0.017        |0.023  |0.031        |
|Percent Medicare Based on Elderly Status |0    |3139 |0.098    |0.8       |0.11         |0.14   |0.17         |
|Percent with Major Depression            |0    |3139 |0.061    |0.0066    |0.056        |0.059  |0.065        |
|Percent with No High School Diploma      |0    |3139 |0.15     |0.058     |0.11         |0.14   |0.19         |
|Percent with Recent Drug Use             |0    |3139 |0.052    |0.011     |0.045        |0.051  |0.057        |
|Percent Severely Disabled                |0    |3139 |0.025    |0.062     |0.02         |0.027  |0.034        |

</br>
</br>

### Table 2: Non-zero Coefficient Estimates Generated from the LASSO

|Term                                  | Coefficient|
|:-------------------------------------|-----------:|
|(Intercept)                           |  76.3507985|
|Percent Poverty                       |  -0.2536480|
|Percent with Age 85+                  |   0.0406592|
|Percent Black                         |  -0.3392134|
|Percent Asian                         |   0.0104569|
|Percent Hispanic                      |   0.1109014|
|Death Rate                            |  -0.9844879|
|Percent with Poor Health Status       |  -0.0751028|
|Percent not Exercise                  |  -0.0916798|
|Percent with High Blood Pres          |  -0.1078510|
|Percent Smoking                       |  -0.1219687|
|Dentist Rate                          |   0.0726649|
|Percent Uninsured                     |  -0.1765169|
|Percent with No High School Diploma   |  -0.1306445|
|Percnet with Recent Drug Use          |   0.0078570|

</br>
</br>

### Table 3: Model Comparison by Root Mean Square Error (RMSE)

|Model          | Mean RMSE| Variance RMSE| 1st Quantile| Median RMSE| 3rd Quantile|
|:--------------|---------:|-------------:|------------:|-----------:|------------:|
|LASSO          |    0.9036|        0.0153|       0.8276|      0.8815|       0.9710|
|MARS           |    0.9275|        0.0354|       0.8253|      0.8770|       0.9864|
|PCR            |    0.9340|        0.0248|       0.8388|      0.8862|       1.0148|
|PLS            |    1.0197|        0.1213|       0.8570|      0.8939|       1.0433|
|Ridge          |    1.2747|        1.2216|       0.8526|      0.9067|       1.0511|
|Least Squares  |    1.3862|        2.3430|       0.8218|      0.8839|       1.0552|
|GAM            |    1.5669|        3.3358|       0.8615|      1.0320|       1.2608|

```{r}
set.seed(3)
trRows <- createDataPartition(data$ale,
                              p = .75,
                              list = F)

data[2,34] = NA
x <- model.matrix(ale~., data)[,-1]
x = x[match(rownames(data), rownames(x)),]

n = dim(data)[2]
for (i in 2 : n){
  x[,names(data)[i]] = data[[i]]
}
rownames(x) = rownames(data)

y <- data$ale


#Train data
x1<-as.matrix(x)[trRows,]
y1<-data$ale[trRows]

#Test data
x2<-as.matrix(x)[-trRows,]
y2<-data$ale[-trRows]
```

```{r}
## `caret`

### Ridge

set.seed(3)
ctrl1 <- trainControl(method = "repeatedcv", number = 10, repeats = 5)
ridge.fit <- train(x1, y1,
                     method = "glmnet",
                     tuneGrid = expand.grid(alpha = 0,  
                                            lambda = exp(seq(-5, 2, length=200))),
                   preProcess = c( "center", "scale", "knnImpute"),
                     trControl = ctrl1)

# plot(ridge.fit, xTrans = function(x1) log(x1)) 

trans = preProcess(x1, method = c("center", "scale", "knnImpute"))

# ridge.fit$bestTune

coef_ridge = coef(ridge.fit$finalModel,ridge.fit$bestTune$lambda)
# head(coef_ridge)

pred_rg = predict(ridge.fit$finalModel, s = ridge.fit$bestTune$lambda, newx = predict(trans, x2),
                  type = "response")
# test MSE
# mean((pred_rg - y2)^2)
```


```{r}
### Lasso

set.seed(3)
lasso.fit <- train(x1, y1,
                   method = "glmnet",
                   tuneGrid = expand.grid(alpha = 1, 
                                          lambda = exp(seq(-4, -1, length=200))),
                   preProcess = c("center", "scale", "knnImpute"),
                   trControl = ctrl1)

plot_2 = plot(lasso.fit, xTrans = function(x1) log(x1))

trans = preProcess(x1, method = c("center", "scale", "knnImpute"))

coef_lasso = 
  predict(lasso.fit$finalModel, newx =  predict(trans,x2), 
                        s = lasso.fit$bestTune$lambda, type ="coefficients")

# nrow(summary(coef_lasso))
# There are 15 non-zero coefficient estimates

predy2.lasso <- predict(lasso.fit$finalModel, newx = predict(trans,x2), 
                        s = lasso.fit$bestTune$lambda, type = "response")
# test MSE
# mean((predy2.lasso - y2)^2)
```


```{r}
# Obtain the number of non-zero coefficient estimates
coef_lasso = coef_lasso %>% 
  as.matrix() %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  rename('coefficient' = '1') 

non_zero_coef = coef_lasso %>% 
  filter(coefficient != 0)

# non_zero_coef %>% nrow() # 15 non-zero coefficient estimates

# non_zero_coef %>% knitr::kable() 
```


```{r}
### Least Square

set.seed(3)

lm.fit <- train(x1, y1,
                method = "lm",
                preProcess = c("center", "scale", "knnImpute"),
                trControl = ctrl1)
```


```{r PCR}
### PCR

set.seed(3)

pcr.fit <- train(x1, y1,
                     method = "pcr",
                     tuneLength = 33,
                   preProcess = c( "center", "scale", "knnImpute"),
                     trControl = ctrl1)


trans = preProcess(x1, method = c("center", "scale", "knnImpute"))



predy2.pcr = predict(pcr.fit$finalModel, newdata = predict(trans, x2), ncomp = pcr.fit$bestTune$ncomp)
# test MSE
# mean((predy2.pcr - y2)^2)

# ggplot(pcr.fit, highlight = TRUE)+ theme_bw()
```


```{r pls}
### PLS

set.seed(3)

pls.fit <- train(x1, y1,
                     method = "pls",
                     tuneLength = 33,
                   preProcess = c( "center", "scale", "knnImpute"),
                     trControl = ctrl1)


trans = preProcess(x1, method = c("center", "scale", "knnImpute"))


predy2.pls = predict(pls.fit$finalModel, newdata = predict(trans, x2), ncomp = pls.fit$bestTune$ncomp)
# test MSE
# mean((predy2.pls - y2)^2)
# ggplot(pls.fit, highlight = TRUE)+ theme_bw()
```


```{r gam}
### GAM

set.seed(3)

gam.fit <- train(x, y,
                 method = "gam",
                 tuneLength = data.frame(method = "GCV.Cp", select = c("TRUE", "FALSE")),
                 preProcess = c( "center", "scale", "knnImpute"),
                 trControl = ctrl1)
# summary(gam.fit)
# plot(gam.fit$finalModel, pages = 4)
```


```{r}
### MARS

mars_grid <- expand.grid(degree = 1:2, 
                         nprune = 3:15)

set.seed(3)

mars.fit <- train(x1, y1,
                 method = "earth",
                 tuneGrid = mars_grid,
                 preProcess = c("center", "scale", "knnImpute"),
                 trControl = ctrl1)

# ggplot(mars.fit)

# mars.fit$bestTune

# coef(mars.fit$finalModel)
```


```{r}
### Table and Plots for RMSE

set.seed(3)

resamp <- resamples(list(lasso = lasso.fit, 
                         ridge = ridge.fit, 
                         lm = lm.fit,
                         pcr = pcr.fit,
                         pls = pls.fit,
                         gam = gam.fit,
                         mars = mars.fit))
# summary(resamp)
# bwplot(resamp, metric = "RMSE")

rmse.df <- resamp$values %>% 
  select(ends_with("~RMSE")) 
```

```{r }
### Summary Table for RMSE across models

table.mse <- rmse.df %>% 
  gather(key = model, value = mse) %>% 
  mutate(model = str_replace(model, "~RMSE", ""),
         model = fct_reorder(model, mse, .desc = FALSE, .fun = mean)) %>%
  group_by(model) %>%
  summarize(
    mean_rmse = mean(mse),
    median_rmse = median(mse),
    variance_rmse = sd(mse)^2,
    Q1 = quantile(mse, .25),
    Q3 = quantile(mse, .75)
  ) 

# table.mse %>% knitr::kable(digits = 4)
```


```{r}
### Plots for RMSE across models
# Density Plot for RMSE
density.mse <- rmse.df %>% 
  gather(key = model, value = mse) %>% 
  mutate(model = str_replace(model, "~RMSE", ""),
         model = fct_reorder(model, mse, .desc = FALSE, .fun = mean)) %>% 
  ggplot(aes(x = mse, colour = model, fill = model)) + 
  geom_density(position = "stack", alpha = 0.3) + 
  labs(
    y = "Density",
    x = "Root Mean Square Error",
    title = sprintf("Model RMSE Comparison")
  ) +
  viridis::scale_fill_viridis(
    option = "magma",
    name = "MSE",
    begin = 1,
    end = 0,
    discrete = TRUE) +
    viridis::scale_colour_viridis(
    option = "magma",
    name = "MSE",
    begin = 1,
    end = 0,
    discrete = TRUE)

# Violin + Box Plot for RMSE
violin.mse <- rmse.df %>% 
  gather(key = model, value = mse) %>% 
  mutate(model = str_replace(model, "~RMSE", ""),
         model = fct_reorder(model, mse, .desc = FALSE, .fun = mean)) %>% 
  ggplot(aes(x = model, y = mse)) + 
  geom_violin(aes(fill = model), trim = FALSE, alpha = 0.3) + 
  geom_boxplot(width = 0.25) +
  labs(
    y = "Root Mean Sqaure Error",
    x = "Model",
    title = sprintf("Comparison of Model RMSE")
  ) +
  viridis::scale_fill_viridis(
    option = "magma",
    name = "Model",
    begin = 1,
    end = 0,
    discrete = TRUE) +
  theme(
    legend.position = "none",
    axis.title.y = element_text(size = 20),
    axis.title.x = element_text(size = 20),
    axis.text.x = element_text(size = 20),
    axis.text.y = element_text(size = 20),
    title = element_text(size = 20)
    )

```


### Figure 1: Correlation Plot

```{r fig.width = 15, fig.height = 15}
data_1 = data

x = model.matrix(ale ~., data_1)[,-1]

corrplot(cor(x), method = "number", number.cex = 0.5, tl.cex = 0.8)
```

### Figure 2: RMSE Predicted by the LASSO Model with Different Tuning Parameters

```{r}
plot_2
```

### Figure 3: Violin Box Plot for Model RMSE Comparison

```{r fig.width = 15, fig.height = 15}
violin.mse
```


